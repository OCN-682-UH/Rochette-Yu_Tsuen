---
author: 'Keanu Rochette '
date: '`r format(Sys.Date())`'
title: Week 10 - Tidy Tuesday 1
output: 
  html_document:
    toc: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```


# Load the libraries
```{r}
library(tidyverse)
library(vegan)
library(RColorBrewer)
library(multcompView)
library(ghibli)
```

# Load the data
```{r}
tuesdata <- tidytuesdayR::tt_load('2024-10-29')

monster_movie_genres <- tuesdata$monster_movie_genres
monster_movies <- tuesdata$monster_movies
```

## Cleaning the Data 
I'm grouping the data by decade by creating a new category.
```{r}
monster_movies <- monster_movies %>% 
  mutate(decade = floor(year / 10) * 10) %>% 
  relocate(decade, .after = year)
```

# Something New: ANOVA & Tukey's Test

This week, I wanted to learn how to run an ANOVA and Tukey's test.   
The code was adapted from:  
[Tutorial for ANOVA and Tukey's Test](https://statdoe.com/one-way-anova-and-box-plot-in-r/)


## Preparing the data

For this data set, we will compare the average ratings of monster movies for the decades 1940, 1980, 1990, 2000, 2010 and 2020.
```{r}
anova_monster <- monster_movies %>% 
  # selecting only the decades of interest
  filter(decade >= 1980 | decade ==1940) %>% 
  # changing the decades into ordered factors
  mutate(decade = factor(decade,
                         levels=c("1940", "1980", "1990",
                                "2000", "2010", "2020"))) %>% 
  # sub-setting the data to only keep the columns of interests
  select(decade, average_rating)

head(anova_monster, 7)
```

```{r}
# running the anova test on the subset of data
anova <- aov(average_rating~decade, data = anova_monster)
summary.aov(anova)
```

```{r}
# Running the Tukey's test to compare the difference between groups
tukey <- TukeyHSD(anova)
print(tukey)
```


```{r}
# Compact Letter display: to show what groups are close to the other ones.
cld <- multcompLetters4(anova,tukey)
print(cld)
```


```{r}
Tk<- anova_monster %>% 
  group_by(decade) %>% 
  summarize(avg = mean(average_rating, na.rm = T),
            quant = quantile(average_rating, probs = 0.75, na.rm = T)) %>% 
  arrange(desc(avg))
```

```{r}
cld <- as.data.frame.list(cld$decade)
Tk$cld <- cld$Letters

print(Tk)
```

## Plotting 
```{r}
anova_monster %>% 
  ggplot(aes(decade, average_rating))+
  geom_boxplot(aes(fill = decade))+
  geom_text(data =Tk, aes(x= decade, y = quant, label = cld),
            size = 4, vjust = -1, hjust =-1)+
  labs(title = "Title",
       subtitle = "Subtitle",
       x = "Decade",
       y = "Average Rating",
       fill = "Decade") +
  theme_bw() + 
  theme(plot.title = element_text(size=14, face = "bold"), 
        plot.subtitle = element_text(size=12),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 12),
        strip.text.x = element_text(size = 12, face = "bold"),
        legend.title=element_text(size=12, face = "bold"),
        legend.text=element_text(size=12),
        axis.text.x = element_text(angle= 45, hjust= 1),
        panel.background = element_rect(fill = "azure1"))+
  #custom the colors 
  scale_fill_ghibli_d("MarnieMedium1", direction =-1)
```


# "Population" Composition Plot


```{r}
movies_div <- monster_movies %>%  
  separate(genres, into = c("genre1", "genre2", "genre3"), sep = ",") %>% 
  select(title_type,genre2, year, decade) %>% 
  group_by(genre2, decade) %>% 
  summarize(
    decade,
    count = n()
  ) %>% distinct() 

```

## Plotting
```{r}
movies_div %>% 
  drop_na() %>% 
  group_by(decade) %>% 
  mutate(tot_count = sum(count, na.rm = T)) %>% 
  ungroup() %>% 
  group_by(decade, genre2) %>% 
  mutate(frac_genre = sum(count, na.rm = T)/tot_count) %>% 
  ggplot() +
  geom_bar(aes(x=decade, y = frac_genre, fill = genre2), stat = "identity", 
           position = "stack", color = "black")+
  geom_text(aes(x=decade, y = -0.03, label = tot_count))+
  geom_text(aes(x=1905, y = -0.03, label = "N="))+
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Title",
       subtitle = "Subtitle",
       x = "Decade",
       y = "Average Rating",
       fill = "Decade") +
  theme_bw() + 
  theme(plot.title = element_text(size=14, face = "bold"), 
        plot.subtitle = element_text(size=12),
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 12),
        strip.text.x = element_text(size = 12, face = "bold"),
        legend.title=element_text(size=12, face = "bold"),
        legend.text=element_text(size=12),
        axis.text.x = element_text(angle= 45, hjust= 1),
        panel.background = element_rect(fill = "azure1"))
```









